<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raksha - SOS Fix</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background-color: #ffebee; padding: 20px; }
        .btn { width: 100%; padding: 25px; font-size: 20px; border: none; border-radius: 15px; color: white; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn-orange { background: linear-gradient(135deg, #ef6c00, #ff9800); }
        .guard-active { background: #333 !important; color: #ff9800 !important; border: 3px solid #ff9800; animation: flash 1s infinite; }
        @keyframes flash { 0% {opacity: 1;} 50% {opacity: 0.6;} 100% {opacity: 1;} }
        #status { margin-top: 25px; font-weight: bold; font-size: 18px; color: #b71c1c; }
    </style>
</head>
<body>

    <h2>üõ°Ô∏è SOS Remote Shield</h2>

    <button id="guardBtn" class="btn btn-orange" onclick="activateGuard()">
        üîó ACTIVATE GUARD
        <br><span style="font-size:12px; font-weight:normal;">(Tap then click Remote)</span>
    </button>

    <div id="status">Status: Offline</div>

    <audio id="sosAudio" loop>
        <source src="https://www.soundjay.com/buttons/beep-01a.mp3" type="audio/mpeg">
    </audio>

    <script>
        const BOT_TOKEN = "8378037937:AAGjuFdZWLnf0kFfTG_QIFCslgvrDMb-sC4";
        const CHAT_ID = "8508792403";
        
        let isGuardActive = false;
        let sosTriggered = false;
        const audio = document.getElementById('sosAudio');

        async function activateGuard() {
            if (isGuardActive) return;
            
            try {
                // Audio chalu karo (Volume bilkul kam)
                audio.volume = 0.05;
                await audio.play();

                // üî¥ MAIN TRICK: Jab remote sound rokega (Pause karega), SOS chalega
                audio.onpause = function() {
                    if (isGuardActive && !sosTriggered) {
                        triggerSOS("Remote (Pause Event)");
                    }
                };

                // Media Session handles for other buttons
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({ title: 'Safety Active' });
                    navigator.mediaSession.setActionHandler('play', () => triggerSOS("Remote Play"));
                    navigator.mediaSession.setActionHandler('pause', () => triggerSOS("Remote Pause"));
                    navigator.mediaSession.setActionHandler('nexttrack', () => triggerSOS("Remote Next"));
                }

                isGuardActive = true;
                document.getElementById('guardBtn').classList.add('guard-active');
                document.getElementById('guardBtn').innerHTML = "üõ°Ô∏è GUARD ACTIVE<br>Press Remote Button Now";
                document.getElementById('status').innerText = "üü¢ System Listening...";
                document.getElementById('status').style.color = "green";

            } catch (err) {
                alert("Please tap again to allow audio.");
            }
        }

        function triggerSOS(source) {
            if (sosTriggered) return;
            sosTriggered = true;

            document.getElementById('status').innerText = "üö® SOS TRIGGERED!";
            document.body.style.backgroundColor = "black";
            
            if (navigator.vibrate) navigator.vibrate([500, 200, 500]);

            // Get Location & Send Telegram
            navigator.geolocation.getCurrentPosition(pos => {
                const msg = `üö® SOS TRIGGERED!\nSource: ${source}\nLoc: https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
                fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${encodeURIComponent(msg)}`);
            });

            // Call Emergency
            setTimeout(() => {
                window.location.href = "tel:112";
            }, 1500);
        }
    </script>
</body>
</html>
